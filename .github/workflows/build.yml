name: Build Skia for PDF creation

on:
  push:
    branches: [ "main" ]
    
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        build_type: [Release]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.x
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'   

    - name: Setup MSVC
      if: matrix.os == 'windows-latest'
      uses: ilammy/msvc-dev-cmd@v1
         
    - name: Build Windows
      if: matrix.os == 'windows-latest'
      shell: pwsh      
      run: |
          git clone --depth 1 https://chromium.googlesource.com/chromium/tools/depot_tools.git
          $env:PATH = "${PWD}/depot_tools;${env:PATH}"

          git clone --depth 1 https://github.com/google/skia.git --branch chrome/m146 
          cd skia
          bin/fetch-ninja
          python tools/git-sync-deps
          bin/gn gen out/release --args='
            is_official_build=true
            is_component_build=false
            is_debug=false
            skia_enable_optimize_size=true
            skia_enable_tools=false
            
            # PDF & Text Support
            skia_enable_pdf=true
            skia_enable_skparagraph=true
            skia_enable_skshaper=true
            skia_enable_skunicode=true
            skia_enable_svg=true
            skia_pdf_subset_harfbuzz=true
            skia_use_harfbuzz=true
            skia_use_icu=true
            skia_use_freetype=true
            skia_enable_fontmgr_custom_embedded=true
            
            # Picture-Support
            skia_use_libpng_decode=true
            skia_use_libpng_encode=true
            skia_use_libjpeg_turbo_decode=true
            skia_use_libjpeg_turbo_encode=true
            
            # Deactivate
            skia_use_fontconfig=false
            skia_enable_ganesh=false
            skia_enable_graphite=false
            skia_use_gl=false
            skia_use_vulkan=false
            skia_use_metal=false
            skia_use_libwebp_decode=false
            skia_use_libwebp_encode=false
            skia_use_libavif=false
            skia_use_lua=false
            skia_use_dng_sdk=false
            skia_use_expat=true
            skia_use_system_expat=false
            skia_use_system_icu=false
            skia_use_system_harfbuzz=false
            skia_use_system_freetype2=false
            skia_use_system_libjpeg_turbo=false
            skia_use_system_libpng=false
            skia_use_system_zlib=false'

            
          ninja -C out/release skia skparagraph skshaper skunicode svg   
          
          New-Item -ItemType Directory -Force -Path dist/include,dist/lib | Out-Null

          Copy-Item -Recurse -Path include/* -Destination dist/include -ErrorAction SilentlyContinue
          Copy-Item -Recurse -Path modules/skparagraph/include/* -Destination dist/include -ErrorAction SilentlyContinue
          Copy-Item -Recurse -Path modules/skshaper/include/* -Destination dist/include -ErrorAction SilentlyContinue
          Copy-Item -Recurse -Path modules/skunicode/include/* -Destination dist/include -ErrorAction SilentlyContinue
          Copy-Item -Recurse -Path modules/svg/include/* -Destination dist/include -ErrorAction SilentlyContinue
          
          cd out/release
          lib.exe /OUT:../../dist/lib/skia_barracuda.lib *.lib
          cd ../..
                    
    - name: Build Linux
      if: matrix.os == 'ubuntu-latest'
      run: |
          git clone --depth 1 https://chromium.googlesource.com/chromium/tools/depot_tools.git
          echo "${{ github.workspace }}/depot_tools" >> $GITHUB_PATH
          export PATH="${PWD}/depot_tools:${PATH}"
          git clone --depth 1 https://github.com/google/skia.git --branch chrome/m146 
          cd skia
          bin/fetch-ninja
          python tools/git-sync-deps
          bin/gn gen out/release --args='
            cc="clang"
            cxx="clang++"
            is_official_build=true
            is_component_build=false
            is_debug=false
            skia_enable_optimize_size=true
            skia_enable_tools=false
            
            # PDF & Text Support
            skia_enable_pdf=true
            skia_enable_skparagraph=true
            skia_enable_skshaper=true
            skia_enable_skunicode=true
            skia_enable_svg=true
            skia_pdf_subset_harfbuzz=true
            skia_use_harfbuzz=true
            skia_use_icu=true
            skia_use_freetype=true
            skia_enable_fontmgr_custom_embedded=true
            
            # Picture-Support
            skia_use_libpng_decode=true
            skia_use_libpng_encode=true
            skia_use_libjpeg_turbo_decode=true
            skia_use_libjpeg_turbo_encode=true
            
            # Deactivate
            skia_use_fontconfig=false
            skia_enable_ganesh=false
            skia_enable_graphite=false
            skia_use_gl=false
            skia_use_vulkan=false
            skia_use_metal=false
            skia_use_libwebp_decode=false
            skia_use_libwebp_encode=false
            skia_use_libavif=false
            skia_use_lua=false
            skia_use_dng_sdk=false
            skia_use_expat=true
            skia_use_system_expat=false
            skia_use_system_icu=false
            skia_use_system_harfbuzz=false
            skia_use_system_freetype2=false
            skia_use_system_libjpeg_turbo=false
            skia_use_system_libpng=false
            skia_use_system_zlib=false'
          
          ninja -C out/release skia skparagraph skshaper skunicode svg
          
          mkdir -p dist/include dist/lib
          
          cp -r include/* dist/include/ 2>/dev/null || true
          cp -r modules/skparagraph/include/* dist/include/ 2>/dev/null || true
          cp -r modules/skshaper/include/* dist/include/ 2>/dev/null || true
          cp -r modules/skunicode/include/* dist/include/ 2>/dev/null || true
          cp -r modules/svg/include/* dist/include/ 2>/dev/null || true

          # rcs: r=ersetzen, c=erstellen, s=index schreiben
          find out/release -name "*.a" -exec ar rcs dist/lib/libskia_barracuda.a {} +

          echo "=== created library ==="
          ls -lh dist/lib/libskia_barracuda.a
          
      shell: bash          
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
          name: skia-build-${{ runner.os }}-${{ matrix.build_type }}
          path: | 
            skia/dist/ 
            skia-*-barracuda.*
          retention-days: 30            
